<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spring Boot Music Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #6f42c1, #6610f2);
            color: white;
            min-height: 100vh;
        }
        .player-container {
            max-width: 700px;
            margin: 40px auto;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .playlist-item:hover {
            background: rgba(255,255,255,0.1);
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="player-container">
    <!-- Now Playing -->
    <div class="mb-4 text-center">
        <h3 id="nowPlayingTitle">üéß No song playing</h3>
        <audio id="audioPlayer" controls class="w-100 mt-2">
            <source id="audioSource" src="" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </div>
    <div class="text-center mt-3">
        <button id="shuffleBtn" class="btn btn-warning me-2">üîÄ Shuffle</button>
    </div>

    <div class="text-center mt-3">
        <button class="btn btn-light mx-2" onclick="moveToPrevSong()">‚èÆÔ∏è Previous</button>
        <button class="btn btn-light mx-2" onclick="moveToNextSong()">‚è≠Ô∏è Next</button>
    </div>

    <div class="text-center mt-3">
        <button id="loopBtn" class="btn btn-info">üîÅ Loop</button>
    </div>

    <!-- Playlist -->
    <div class="mb-4">
        <h4>üéµ Playlist</h4>
        <ul id="playlist" class="list-group text-dark">
            <!-- Songs will be listed here dynamically -->
        </ul>
    </div>

    <!-- Upload -->
    <div>
        <h4>‚¨ÜÔ∏è Upload New Song</h4>
        <form id="uploadForm" method="post" action="/upload">
            <div class="input-group">
                <input type="file" id="fileInput" class="form-control" accept="audio/*" required>
                <button class="btn btn-success" type="submit">Upload</button>
            </div>
        </form>
        <div id="uploadStatus" class="mt-2"></div>
    </div>
</div>

<script>
    const playlistElement = document.getElementById('playlist');
    const audioPlayer = document.getElementById('audioPlayer');
    const audioSource = document.getElementById('audioSource');
    const nowPlayingTitle = document.getElementById('nowPlayingTitle');

    let playList = [];
    let currentSongIndex=0;

    let shuffleMode = false;
    let loopMode = false;

    // Load playlist from backend
    async function loadPlaylist() {
        playlistElement.innerHTML = '';
        const response = await fetch('http://localhost:8080/api/music/list');
        const songs = await response.json();
        playList = songs;
        songs.forEach(song => {
            const li = document.createElement('li');
            li.textContent = song;
            li.className = 'list-group-item playlist-item';
            li.addEventListener('click', () => {
                    playSong(song)
                }
            );
            playlistElement.appendChild(li);
        });
    }

    // Play selected song
    function playSong(song) {
        audioSource.src = `http://localhost:8080/api/music/play/${song}`;
        audioPlayer.load();
        audioPlayer.play();
        nowPlayingTitle.textContent = `üé∂ Now Playing: ${song}`;
        currentSongIndex = playList.indexOf(song)
        console.log("current song = "+ song)
        highlightCurrentSong();
    }

    // play the next song in playlist
    function moveToNextSong(){
        if (loopMode) {
            // just replay the same song
            playSong(playList[currentSongIndex]);
            return;
        }

        if (shuffleMode) {
            // pick a random song that's not the current one (optional)
            let nextIndex;
            do {
                nextIndex = Math.floor(Math.random() * playList.length);
            } while (nextIndex === currentSongIndex && playList.length > 1);

            currentSongIndex = nextIndex;
            playSong(playList[currentSongIndex]);
            return;
        }

        currentSongIndex++;
        if (currentSongIndex >= playList.length) {
            currentSongIndex = 0; // loop back
        }
        console.log("moving to next song");
        playSong(playList[currentSongIndex]);
    }
    // play the previous song in playlist
    function moveToPrevSong() {
        currentSongIndex--;
        if (currentSongIndex < 0) {
            currentSongIndex = playList.length - 1;
        }
        playSong(playList[currentSongIndex]);
    }

    // Handle file upload
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('http://localhost:8080/api/music/upload', {
            method: 'POST',
            body: formData
        });

        const message = await response.text();
        document.getElementById('uploadStatus').textContent = message;

        loadPlaylist();
    });

    // handle moving to next song
    audioPlayer.addEventListener('ended',moveToNextSong);

    // highlight current playing song
    function highlightCurrentSong() {
        document.querySelectorAll('.playlist-item').forEach((li, index) => {
            li.classList.toggle('active', index === currentSongIndex);
        });
    }

    // shuffle and loop over changes
    document.getElementById('shuffleBtn').addEventListener('click', () => {
        shuffleMode = !shuffleMode;
        document.getElementById('shuffleBtn').classList.toggle('btn-success', shuffleMode);
        document.getElementById('shuffleBtn').classList.toggle('btn-warning', !shuffleMode);
    });

    document.getElementById('loopBtn').addEventListener('click', () => {
        loopMode = !loopMode;
        document.getElementById('loopBtn').classList.toggle('btn-success', loopMode);
        document.getElementById('loopBtn').classList.toggle('btn-info', !loopMode);
    });

    // Load songs on page load
    loadPlaylist();
</script>

</body>
</html>
